#!/usr/bin/python
# -*- coding: UTF-8 -*-
# vim: set fileencoding=utf-8 :
#
# SZARP: SCADA software 
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA

"""
Wrapper for running ipk2szarp configuration parser
and for displaying suggestions to user.
"""

import argparse
from subprocess import Popen, PIPE
import pysvn
import sys
import os
from clint.textui import puts, indent, colored
from clint.textui.core import STDOUT, STDERR
from lxml import etree
import hashlib
import re

error_count = 0
def printerr(msg, prefix="ERROR: "):
	global error_count
	error_count = error_count + 1
	puts(colored.red(prefix + "(" + str(error_count) + ") " + str(msg)), stream=STDERR)

note_count = 0
def printnote(msg, prefix="NOTE: "):
	global note_count
	note_count = note_count + 1
	puts(colored.yellow(prefix + "(" + str(note_count) + ") " + str(msg)))

def printok(msg):
	puts(colored.green(str(msg)))

def get_szarp_uncommited():
	# without realpath client.info() strips the symlink
	szarp_path = os.path.realpath("/etc/szarp/default/")
	client = pysvn.Client()
	is_svn_repo = True
	try:
		client.info(szarp_path)
	except:
		is_svn_repo = False
	if is_svn_repo:
		changes = client.status(szarp_path, get_all=False)
		interesting = set([pysvn.wc_status_kind.added, pysvn.wc_status_kind.deleted,\
			pysvn.wc_status_kind.modified, pysvn.wc_status_kind.conflicted])
		uncommited = [f.path for f in changes if f.text_status in interesting]
		uncommited_present = len(uncommited) > 0
	else:
		uncommited_present = None
	return is_svn_repo, uncommited_present


conf_parser = "/opt/szarp/bin/ipk2szarp"
iks_server = "/opt/szarp/bin/iks-server"

def check_iks():
	if os.path.isfile(iks_server):
		printnote("if only draw configuration has changed: supervisorctl restart iks-server")

def check_svn():
	szarp_svn, szarp_uncommited = get_szarp_uncommited()
	realpath = os.path.realpath("/etc/szarp/default")
	if szarp_svn:
		if szarp_uncommited:
			printnote("uncommited changes found in " + realpath + ": /opt/szarp/bin/conf-put.sh")
	else:
		printnote(realpath + " is not added to svn, maybe it should?")

def parse_config_file():
	options = etree.XMLParser(remove_blank_text=True, remove_comments=True)
	if args.input_file is None:
		szarp_path = os.path.realpath("/etc/szarp/default")
		xml_path = szarp_path + "/config/params.xml"
	else:
		xml_path = args.input_file
	xml_file = etree.parse(xml_path, options)
	params = xml_file.getroot()
	parameters = list(params)
	return parameters

def check_exist(parameters):
	file_to_check = re.compile(r"\/opt\/szarp\/.")
	check_list = []
	for device in parameters:
		for attr, value in device.items():
			find_file = file_to_check.search(value)
			if find_file is not None:
				if os.path.exists(value) is False:
					if not value in check_list:
						printerr(value + " does not exist!")
						check_list.insert(0,value)

def check_custom(parameters):
	md5sum_regex = re.compile(r"[a-f0-9]{32}")
	daemon_regex = re.compile(r"(?<=\/opt\/szarp\/bin\/).*")
	daemons_list = []
	for device in parameters:
		for attr, value in device.items():
			if attr == "daemon":
				if not value in daemons_list:
					daemons_list.insert(0,value)
					md5sum_check = 0
					daemon = daemon_regex.search(value)
					with open("/var/lib/dpkg/info/szarp-daemons.md5sums", "r") as md5file:
						for line in md5file:
							standard_daemon_md5sum = re.search(r"[a-f0-9]{32}.{16}" + daemon.group(0) , line)
							if standard_daemon_md5sum is not None:
								md5sum = md5sum_regex.search(line)
								md5sum_check = md5sum.group(0)
								break
					try:
						daemon_md5sum = hashlib.md5(open(value, 'rb').read()).hexdigest()
					except:
						daemon_md5sum = 0
					if md5sum_check != daemon_md5sum is not None:
						printnote("custom daemon found in " + value)

def check_config(parameters):
	namespace = "{http://www.praterm.com.pl/SZARP/ipk}"
	for device in parameters:
		if device.tag == namespace + "device":
			for unit in device:
				for elements in unit:
					if elements.tag == namespace + "param":
						find_unit = False
						for attr, value in elements.items():
							if attr == "unit":
								find_unit = True
						if find_unit is False:
							printerr("atribute 'unit' in node 'param' not found (line  " + str(elements.sourceline) + ")")
					elif elements.tag == namespace + "send":
						try:
							if elements.getnext().tag != namespace + "send":
								printnote("found wrong order of 'send' elements (line " + str(elements.sourceline) + ")")
						except:
							pass
						for attr, value in elements.items():
							found_param_or_value = False
							if attr == "param" or attr == "value":
								found_param_or_value = True
								break
						if found_param_or_value is False:
							printerr("found send without param or value (line " + str(elements.sourceline) + ")")

parser = argparse.ArgumentParser(description='Parses params.xml and checks for errors.')
parser.add_argument('-i', '--input-file',
	help='XML config file (default is params.xml), passed to ipk2szarp')
parser.add_argument('-d', '--debug', type=int,
	help='debug level from 0 (errors only) to 9, passed to ipk2szarp')

args = parser.parse_args()

command = [conf_parser]

if args.debug:
	command.append('--debug=' + str(args.debug))

if args.input_file:
	command.append(args.input_file)

process = Popen(command, stderr=PIPE)
stdout, stderr = process.communicate()
if stderr:
	printerr(stderr.rstrip(), '')
return_code = process.returncode

if return_code == 0:
	printnote("if backend configuration has changed: /etc/init.d/parstart restart")
	check_iks()
	check_svn()
	config = parse_config_file()
	check_exist(config)
	check_custom(config)
	check_config(config)
	if error_count == 0:
		printok("OK")
else:
	printerr("ERROR", '')
